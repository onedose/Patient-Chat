<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Patient Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fas fa-capsules"></i>
            OneDose
        </div>
        <div class="navbar-search">
            <div class="patient-search-container">
                <input 
                    type="text" 
                    id="patientSearchInput" 
                    placeholder="Search by Patient ID or Name" 
                    class="patient-search-input"
                    onfocus="showPatientSearchPopup()"
                >
                <button class="patient-search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="navbar-actions">
            <div class="profile-icon">DR</div>
        </div>
    </nav>

    <div class="container">
        <!-- Left Panel - Medicine List -->
        <div class="panel">
            <div class="panel-header">
                <h2>My Medications</h2>
            </div>
            
            <div class="search-bar">
                <input type="text" placeholder="Search medications..." onkeyup="searchMedications(this.value)">
            </div>

            <div class="medicine-list">
                <!-- Medicine Card 1 -->
                <div class="medicine-card" onclick="toggleDetails(this)">
                    <div class="medicine-header">
                        <div class="medicine-title">
                            <i class="fas fa-pills" style="color: var(--primary-color)"></i>
                            <h3>Amoxicillin 500mg</h3>
                        </div>
                        <span class="medicine-badge badge-active">Active</span>
                    </div>
                    <div class="medicine-details" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <h4>Day Frequency</h4>
                                <p>M-T-0-0-0-Sa-Su</p>
                            </div>
                            <div class="detail-item">
                                <h4>Dose Frequency</h4>
                                <p>1-1-1-0</p>
                            </div>
                            <div class="detail-item">
                                <h4>Progress</h4>
                                <p>14 days remaining</p>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 40%"></div>
                                </div>
                            </div>
                            <div class="detail-item">
                                <h4>Duration</h4>
                                <p>05/02/2025 - 07/03/2025</p>
                            </div>
                        </div>
                        <p><strong>Instructions:</strong> Take with food. Complete the full course.</p>
                        <div class="quick-actions">
                            <button class="action-btn secondary-btn">
                                <i class="fas fa-notes-medical"></i>
                                View History
                            </button>
                            <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                                <i class="fas fa-info-circle"></i>
                                Explain Medicine
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Medicine Card 2 -->
                <div class="medicine-card" onclick="toggleDetails(this)">
                    <div class="medicine-header">
                        <div class="medicine-title">
                            <i class="fas fa-capsules" style="color: var(--warning-color)"></i>
                            <h3>Lisinopril 10mg</h3>
                        </div>
                        <span class="medicine-badge badge-expiring">Refill Soon</span>
                    </div>
                    <div class="medicine-details" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <h4>Frequency</h4>
                                <p>Once daily</p>
                            </div>
                            <div class="detail-item">
                                <h4>Duration</h4>
                                <p>Ongoing</p>
                            </div>
                            <div class="detail-item">
                                <h4>Supply Left</h4>
                                <p>5 days remaining</p>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 15%"></div>
                                </div>
                            </div>
                            <div class="detail-item">
                                <h4>Next Dose</h4>
                                <p>Tomorrow 8:00 AM</p>
                            </div>
                        </div>
                        <p><strong>Instructions:</strong> Take in the morning. Avoid grapefruit.</p>
                        <div class="quick-actions">
                            <button class="action-btn secondary-btn">
                                <i class="fas fa-notes-medical"></i>
                                View History
                            </button>
                            <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                                <i class="fas fa-info-circle"></i>
                                Explain Medicine
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - AI Assistant -->
        <div class="panel">
            <div class="patient-info">
                <div class="patient-avatar">JD</div>
                <div class="patient-details">
                    <h3>John Doe</h3>
                    <p>Next Appointment: March 1, 2025</p>
                    <p style="color: var(--text-secondary)">Patient ID: #12345</p>
                </div>
            </div>
            
            <div class="doctor-instructions">
                <div class="panel-header">
                    <h3>Doctor's Instructions</h3>
                    <div class="language-toggle">
                        <button class="action-btn secondary-btn language-btn active" data-lang="en">
                            <i class="fas fa-language"></i> English
                        </button>
                        <button class="action-btn secondary-btn language-btn" data-lang="hi">
                            <i class="fas fa-language"></i> हिंदी
                        </button>
                    </div>
                </div>
                
                <div class="instruction-content">
                    <div class="instruction-text" data-lang="en">
                        <p>Take Amoxicillin 500mg three times a day after meals. Complete the entire course of antibiotics even if you start feeling better. Avoid alcohol and dairy products 2 hours before and after taking the medication.</p>
                        <div class="instruction-actions">
                            <button class="action-btn primary-btn play-instructions-btn">
                                <i class="fas fa-play-circle"></i> Play Instructions
                            </button>
                        </div>
                    </div>
                    
                    <div class="instruction-text" data-lang="hi" style="display: none;">
                        <p>अमोक्सीसिलिन 500 मिलीग्राम को दिन में तीन बार भोजन के बाद लें। एंटीबायोटिक का पूरा कोर्स पूरा करें, भले ही आप बेहतर महसूस करने लगें। दवा लेने से 2 घंटे पहले और बाद में शराब और डेयरी उत्पादों से बचें।</p>
                        <div class="instruction-actions">
                            <button class="action-btn primary-btn play-instructions-btn">
                                <i class="fas fa-play-circle"></i> निर्देश सुनें
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ai-assistant">
                <div class="chat-header">
                    <div class="chat-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="chat-info">
                        <h3>OneDose AI Assistant</h3>
                        <p>Your personal health companion</p>
                    </div>
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message bot-message">
                            <div class="message-content">
                                <p>Hello! I'm your OneDose AI Assistant. How can I help you today?</p>
                            </div>
                        </div>
                        <div class="chat-message suggestion-message">
                            <div class="message-content">
                                <p>Quick suggestions:</p>
                                <div class="quick-suggestions">
                                    <button class="suggestion-chip" onclick="sendQuickQuestion('What are the side effects of Amoxicillin?')">
                                        <i class="fas fa-pills"></i> Amoxicillin Effects
                                    </button>
                                    <button class="suggestion-chip" onclick="sendQuickQuestion('How should I store my medications?')">
                                        <i class="fas fa-box-archive"></i> Medication Storage
                                    </button>
                                    <button class="suggestion-chip" onclick="sendQuickQuestion('What if I miss a dose?')">
                                        <i class="fas fa-clock"></i> Missed Dose
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="chat-input-wrapper">
                        <button class="voice-input-btn" id="voiceInputBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <input 
                            type="text" 
                            id="chatInput" 
                            placeholder="Type your health question..." 
                            onkeypress="handleChatInput(event)"
                        >
                        <button class="send-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="voiceStatus" class="voice-status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Search Popup -->
    <div id="patientSearchPopup" class="patient-search-popup">
        <div class="patient-search-popup-content">
            <div class="patient-search-header">
                <input 
                    type="text" 
                    id="patientSearchPopupInput" 
                    placeholder="Search patients..." 
                >
                <button class="close-popup-btn" onclick="closePatientSearchPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="patientSearchResults" class="patient-search-popup-results">
                <!-- Patient results will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="chat.js"></script>
    <script src="patient-search.js"></script>
    <script>
        // Initial toggleDetails function for expanding/collapsing cards
        // Speech Recognition Setup
const setupSpeechRecognition = () => {
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const chatInput = document.getElementById('chatInput');
    const voiceStatus = document.getElementById('voiceStatus');

    // Fallback for different browser implementations
    const SpeechRecognition = 
        window.SpeechRecognition || 
        window.webkitSpeechRecognition || 
        window.mozSpeechRecognition || 
        window.msSpeechRecognition;

    if (!SpeechRecognition) {
        voiceInputBtn.style.display = 'none';
        voiceStatus.textContent = 'Speech recognition not supported in this browser';
        voiceStatus.style.color = '#dc2626';
        return;
    }

    const recognition = new SpeechRecognition();
    
    // Configuration
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    // Event Handlers
    recognition.onstart = () => {
        voiceInputBtn.classList.add('active');
        voiceStatus.textContent = 'Listening... Speak now';
        voiceStatus.style.color = 'var(--primary-color)';
        voiceInputBtn.querySelector('i').classList.remove('fa-microphone');
        voiceInputBtn.querySelector('i').classList.add('fa-microphone-lines');
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        
        if (transcript) {
            chatInput.value = transcript;
            voiceStatus.textContent = 'Processing your request...';
            voiceStatus.style.color = 'var(--success-color)';
            
            // Automatically send message after a short delay
            setTimeout(() => {
                sendMessage();
            }, 500);
        }
    };

    recognition.onend = () => {
        voiceInputBtn.classList.remove('active');
        voiceInputBtn.querySelector('i').classList.remove('fa-microphone-lines');
        voiceInputBtn.querySelector('i').classList.add('fa-microphone');
        voiceStatus.textContent = '';
    };

    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        voiceInputBtn.classList.remove('active');

        // Provide user-friendly error messages
        switch(event.error) {
            case 'no-speech':
                voiceStatus.textContent = 'No speech detected. Please try again.';
                break;
            case 'audio-capture':
                voiceStatus.textContent = 'No microphone found. Check your device settings.';
                break;
            case 'not-allowed':
                voiceStatus.textContent = 'Microphone access denied. Please check browser permissions.';
                break;
            default:
                voiceStatus.textContent = 'Speech recognition failed. Please try again.';
        }
        voiceStatus.style.color = '#dc2626';
    };

    // Voice Input Button Click Handler
    voiceInputBtn.addEventListener('click', () => {
        try {
            recognition.abort(); // Stop any ongoing recognition
            recognition.start(); // Start new recognition
        } catch (error) {
            console.error('Speech recognition error:', error);
            voiceStatus.textContent = 'Speech recognition not available';
            voiceStatus.style.color = '#dc2626';
        }
    });

    // Add language selector
    const languageSelect = document.createElement('select');
    languageSelect.innerHTML = `
        <option value="en-US">English</option>
        <option value="hi-IN">Hindi</option>
        <option value="es-ES">Spanish</option>
        <option value="fr-FR">French</option>
    `;
    languageSelect.addEventListener('change', (e) => {
        recognition.lang = e.target.value;
    });
    languageSelect.style.marginLeft = '12px';
    languageSelect.style.padding = '4px';
    languageSelect.style.borderRadius = '4px';

    // Append language select near voice input
    voiceInputBtn.parentNode.insertBefore(languageSelect, voiceInputBtn.nextSibling);
};

// Initialize speech recognition when the DOM is loaded
document.addEventListener('DOMContentLoaded', setupSpeechRecognition);
        function toggleDetails(card) {
            const details = card.querySelector('.medicine-details');
            const allDetails = document.querySelectorAll('.medicine-details');
            
            // Close all other details
            allDetails.forEach(detail => {
                if (detail !== details) {
                    detail.style.display = 'none';
                }
            });

            // Toggle clicked details
            if (details.style.display === 'block') {
                details.style.display = 'none';
            } else {
                details.style.display = 'block';
            }
        }

        // Function to handle search functionality
        function searchMedications(query) {
            query = query.toLowerCase();
            const cards = document.querySelectorAll('.medicine-card');
            
            cards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const details = card.querySelector('.medicine-details').textContent.toLowerCase();
                
                if (title.includes(query) || details.includes(query)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Chatbot Functionality
        function createMessageElement(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', `${type}-message`);
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            contentDiv.innerHTML = `<p>${message}</p>`;
            
            messageDiv.appendChild(contentDiv);
            return messageDiv;
        }

        function appendMessage(message, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = createMessageElement(message, type);
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendQuickQuestion(question) {
            // Add user message
            appendMessage(question, 'user');

            try {
                // Use fetchGeminiResponse from chat.js
                const response = await fetchGeminiResponse(question);
                
                // Add bot response
                appendMessage(response, 'bot');
            } catch (error) {
                appendMessage('Sorry, I couldn\'t process that request.', 'bot');
            }
        }

        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            if (message) {
                // Add user message
                appendMessage(message, 'user');
                
                // Clear input
                chatInput.value = '';

                try {
                    // Use fetchGeminiResponse from chat.js
                    const response = await fetchGeminiResponse(message);
                    
                    // Add bot response
                    appendMessage(response, 'bot');
                } catch (error) {
                    appendMessage('Sorry, I couldn\'t process that request.', 'bot');
                }
            }
        }

        // Optional: Add a welcome message after page load
        document.addEventListener('DOMContentLoaded', () => {
            const welcomeMessages = [
                "Hello! I'm your OneDose AI Health Assistant.",
                "Need help understanding your medications?",
                "I'm here to answer your health-related questions."
            ];

            // Randomly select a welcome message
            const randomWelcome = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
            
            // Simulate typing effect for welcome message
            setTimeout(() => {
                appendMessage(randomWelcome, 'bot');
            }, 300);
        });

        // Language Toggle Functionality
        document.addEventListener('DOMContentLoaded', () => {
            const languageButtons = document.querySelectorAll('.language-btn');
            const instructionTexts = document.querySelectorAll('.instruction-text');
            const playButtons = document.querySelectorAll('.play-instructions-btn');

            languageButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const lang = button.dataset.lang;

                    // Toggle active state on buttons
                    languageButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    // Show/hide instruction texts
                    instructionTexts.forEach(text => {
                        text.style.display = text.dataset.lang === lang ? 'block' : 'none';
                    });
                });
            });

        // Play Instructions (Text-to-Speech)
        playButtons.forEach(button => {
            button.addEventListener('click', () => {
                const activeInstructionText = button.closest('.instruction-text').textContent.trim();

                
                // Use Web Speech API for text-to-speech
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(activeInstructionText);
                    // Set language based on active language
                    console.log(button.closest('.instruction-text').dataset.lang);
                    utterance.lang = button.closest('.instruction-text').dataset.lang === 'hi' ? 'hi-IN' : 'en-US';
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Text-to-speech not supported in this browser.');
                }
            });
        });
    });
    </script>
</body>
</html>