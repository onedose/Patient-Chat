<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Patient Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fas fa-capsules"></i>
            OneDose
        </div>
        <div class="navbar-search">
            <div class="patient-search-container">
                <input 
                    type="text" 
                    id="patientSearchInput" 
                    placeholder="Search by Patient ID or Name" 
                    class="patient-search-input"
                    onfocus="showPatientSearchPopup()"
                >
                <button class="patient-search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="navbar-actions">
            <div class="profile-icon">DR</div>
        </div>
    </nav>

    <div class="container">
        <!-- Left Panel - Medicine List -->
        <div class="panel">
            <div class="panel-header">
                <h2>My Medications</h2>
            </div>
            
            <div class="search-bar">
                <input type="text" placeholder="Search medications..." onkeyup="searchMedications(this.value)">
            </div>

            <!-- Replace the existing medicine-list div with this updated version -->
<div class="medicine-list">
    <!-- Morning Medications -->
    <div class="time-group">
        
        <!-- Aspirin -->
        <div class="medicine-card" onclick="toggleDetails(this)">
            <div class="medicine-header">
                <div class="medicine-title">
                    <i class="fas fa-pills" style="color: var(--primary-color)"></i>
                    <h3>Aspirin 75mg</h3>
                </div>
                <span class="medicine-badge badge-active">Active</span>
            </div>
            <div class="medicine-details" style="display: none;">
                <div class="detail-grid">
                    <div class="detail-item">
                        <h4>Day Frequency</h4>
                        <p>M-T-W-Th-F-Sa-Su</p>
                    </div>
                    <div class="detail-item">
                        <h4>Dose Frequency</h4>
                        <p>1-0-0-0</p>
                    </div>
                    <div class="detail-item">
                        <h4>Quantity</h4>
                        <p>1 tablet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <h4>Duration</h4>
                        <p>Long-term</p>
                    </div>
                </div>
                <p><strong>Instructions:</strong> Take with food to prevent blood clots. Do not stop without consulting a doctor.</p>
                <div class="quick-actions">
                    <button class="action-btn secondary-btn">
                        <i class="fas fa-notes-medical"></i>
                        View History
                    </button>
                    <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                        <i class="fas fa-info-circle"></i>
                        Explain Medicine
                    </button>
                </div>
            </div>
        </div>
        <div class="medicine-card" onclick="toggleDetails(this)">
            <div class="medicine-header">
                <div class="medicine-title">
                    <i class="fas fa-pills" style="color: var(--primary-color)"></i>
                    <h3>Ramipril 5 mg</h3>
                </div>
                <span class="medicine-badge badge-active">Active</span>
            </div>
            <div class="medicine-details" style="display: none;">
                <div class="detail-grid">
                    <div class="detail-item">
                        <h4>Day Frequency</h4>
                        <p>M-T-W-Th-F-Sa-Su</p>
                    </div>
                    <div class="detail-item">
                        <h4>Dose Frequency</h4>
                        <p>1-0-0-0</p>
                    </div>
                    <div class="detail-item">
                        <h4>Quantity</h4>
                        <p>1 tablet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <h4>Duration</h4>
                        <p>Long-term</p>
                    </div>
                </div>
                <p><strong>Instructions:</strong> Take with food to prevent blood clots. Do not stop without consulting a doctor.</p>
                <div class="quick-actions">
                    <button class="action-btn secondary-btn">
                        <i class="fas fa-notes-medical"></i>
                        View History
                    </button>
                    <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                        <i class="fas fa-info-circle"></i>
                        Explain Medicine
                    </button>
                </div>
            </div>
        </div>
        <div class="medicine-card" onclick="toggleDetails(this)">
            <div class="medicine-header">
                <div class="medicine-title">
                    <i class="fas fa-pills" style="color: var(--primary-color)"></i>
                    <h3>Atorvastatin 40mg</h3>
                </div>
                <span class="medicine-badge badge-active">Active</span>
            </div>
            <div class="medicine-details" style="display: none;">
                <div class="detail-grid">
                    <div class="detail-item">
                        <h4>Day Frequency</h4>
                        <p>M-T-W-Th-F-Sa-Su</p>
                    </div>
                    <div class="detail-item">
                        <h4>Dose Frequency</h4>
                        <p>1-0-0-0</p>
                    </div>
                    <div class="detail-item">
                        <h4>Quantity</h4>
                        <p>1 tablet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <h4>Duration</h4>
                        <p>Long-term</p>
                    </div>
                </div>
                <p><strong>Instructions:</strong> Take with food to prevent blood clots. Do not stop without consulting a doctor.</p>
                <div class="quick-actions">
                    <button class="action-btn secondary-btn">
                        <i class="fas fa-notes-medical"></i>
                        View History
                    </button>
                    <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                        <i class="fas fa-info-circle"></i>
                        Explain Medicine
                    </button>
                </div>
            </div>
        </div>

        <!-- Metformin -->
        <div class="medicine-card" onclick="toggleDetails(this)">
            <div class="medicine-header">
                <div class="medicine-title">
                    <i class="fas fa-capsules" style="color: var(--primary-color)"></i>
                    <h3>Metformin 500mg</h3>
                </div>
                <span class="medicine-badge badge-active">Active</span>
            </div>
            <div class="medicine-details" style="display: none;">
                <div class="detail-grid">
                    <div class="detail-item">
                        <h4>Day Frequency</h4>
                        <p>M-T-W-Th-F-Sa-Su</p>
                    </div>
                    <div class="detail-item">
                        <h4>Dose Frequency</h4>
                        <p>1-0-0-0</p>
                    </div>
                    <div class="detail-item">
                        <h4>Quantity</h4>
                        <p>1 tablet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <h4>Duration</h4>
                        <p>Continuous</p>
                    </div>
                </div>
                <p><strong>Instructions:</strong> For blood sugar control. Stop if experiencing nausea, muscle pain, or severe weakness.</p>
                <div class="quick-actions">
                    <button class="action-btn secondary-btn">
                        <i class="fas fa-notes-medical"></i>
                        View History
                    </button>
                    <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                        <i class="fas fa-info-circle"></i>
                        Explain Medicine
                    </button>
                </div>
            </div>
        </div>

        <!-- Similar format for other morning medications -->
    </div>

    <!-- Afternoon Medications -->
    <div class="time-group">
        
        <!-- Furosemide -->
        <div class="medicine-card" onclick="toggleDetails(this)">
            <div class="medicine-header">
                <div class="medicine-title">
                    <i class="fas fa-pills" style="color: var(--warning-color)"></i>
                    <h3>Furosemide 40mg</h3>
                </div>
                <span class="medicine-badge badge-active">Active</span>
            </div>
            <div class="medicine-details" style="display: none;">
                <div class="detail-grid">
                    <div class="detail-item">
                        <h4>Day Frequency</h4>
                        <p>M-T-W-Th-F-Sa-Su</p>
                    </div>
                    <div class="detail-item">
                        <h4>Dose Frequency</h4>
                        <p>1-0-0-0</p>
                    </div>
                    <div class="detail-item">
                        <h4>Quantity</h4>
                        <p>1 tablet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <h4>Duration</h4>
                        <p>Continuous</p>
                    </div>
                </div>
                <p><strong>Instructions:</strong> For fluid retention. Monitor urine output; stop if severe dehydration, dizziness, or weakness occurs.</p>
                <div class="quick-actions">
                    <button class="action-btn secondary-btn">
                        <i class="fas fa-notes-medical"></i>
                        View History
                    </button>
                    <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                        <i class="fas fa-info-circle"></i>
                        Explain Medicine
                    </button>
                </div>
            </div>
        </div>
        <div class="medicine-card" onclick="toggleDetails(this)">
            <div class="medicine-header">
                <div class="medicine-title">
                    <i class="fas fa-pills" style="color: var(--warning-color)"></i>
                    <h3>Clopidogrel 75mg</h3>
                </div>
                <span class="medicine-badge badge-active">Active</span>
            </div>
            <div class="medicine-details" style="display: none;">
                <div class="detail-grid">
                    <div class="detail-item">
                        <h4>Day Frequency</h4>
                        <p>M-T-W-Th-F-Sa-Su</p>
                    </div>
                    <div class="detail-item">
                        <h4>Dose Frequency</h4>
                        <p>1-0-0-0</p>
                    </div>
                    <div class="detail-item">
                        <h4>Quantity</h4>
                        <p>1 tablet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <h4>Duration</h4>
                        <p>Continuous</p>
                    </div>
                </div>
                <p><strong>Instructions:</strong> For fluid retention. Monitor urine output; stop if severe dehydration, dizziness, or weakness occurs.</p>
                <div class="quick-actions">
                    <button class="action-btn secondary-btn">
                        <i class="fas fa-notes-medical"></i>
                        View History
                    </button>
                    <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                        <i class="fas fa-info-circle"></i>
                        Explain Medicine
                    </button>
                </div>
            </div>
        </div>

        <!-- Similar format for other afternoon medications -->
    </div>

    <!-- Evening Medications -->
    <div class="time-group">
        
        <!-- Diltiazem -->
        <div class="medicine-card" onclick="toggleDetails(this)">
            <div class="medicine-header">
                <div class="medicine-title">
                    <i class="fas fa-pills" style="color: var(--success-color)"></i>
                    <h3>Diltiazem 120mg SR</h3>
                </div>
                <span class="medicine-badge badge-active">Active</span>
            </div>
            <div class="medicine-details" style="display: none;">
                <div class="detail-grid">
                    <div class="detail-item">
                        <h4>Day Frequency</h4>
                        <p>M-T-W-Th-F-Sa-Su</p>
                    </div>
                    <div class="detail-item">
                        <h4>Dose Frequency</h4>
                        <p>1-0-0-0</p>
                    </div>
                    <div class="detail-item">
                        <h4>Quantity</h4>
                        <p>1 tablet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <h4>Duration</h4>
                        <p>Continuous</p>
                    </div>
                </div>
                <p><strong>Instructions:</strong> For heart rate and BP control. Do not take with grapefruit juice; stop if severe dizziness or slow heart rate occurs.</p>
                <div class="quick-actions">
                    <button class="action-btn secondary-btn">
                        <i class="fas fa-notes-medical"></i>
                        View History
                    </button>
                    <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                        <i class="fas fa-info-circle"></i>
                        Explain Medicine
                    </button>
                </div>
            </div>
        </div>
        <div class="medicine-card" onclick="toggleDetails(this)">
            <div class="medicine-header">
                <div class="medicine-title">
                    <i class="fas fa-pills" style="color: var(--success-color)"></i>
                    <h3>Metoprolol 50 mg</h3>
                </div>
                <span class="medicine-badge badge-active">Active</span>
            </div>
            <div class="medicine-details" style="display: none;">
                <div class="detail-grid">
                    <div class="detail-item">
                        <h4>Day Frequency</h4>
                        <p>M-T-W-Th-F-Sa-Su</p>
                    </div>
                    <div class="detail-item">
                        <h4>Dose Frequency</h4>
                        <p>1-0-0-0</p>
                    </div>
                    <div class="detail-item">
                        <h4>Quantity</h4>
                        <p>1 tablet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <h4>Duration</h4>
                        <p>Continuous</p>
                    </div>
                </div>
                <p><strong>Instructions:</strong> For heart rate and BP control. Do not take with grapefruit juice; stop if severe dizziness or slow heart rate occurs.</p>
                <div class="quick-actions">
                    <button class="action-btn secondary-btn">
                        <i class="fas fa-notes-medical"></i>
                        View History
                    </button>
                    <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                        <i class="fas fa-info-circle"></i>
                        Explain Medicine
                    </button>
                </div>
            </div>
        </div>

        <!-- Similar format for other evening medications -->
    </div>

    <!-- Night Medications -->
    <div class="time-group">
        
        <!-- Warfarin -->
        <div class="medicine-card" onclick="toggleDetails(this)">
            <div class="medicine-header">
                <div class="medicine-title">
                    <i class="fas fa-pills" style="color: var(--danger-color)"></i>
                    <h3>Warfarin 5mg</h3>
                </div>
                <span class="medicine-badge badge-active">Active</span>
            </div>
            <div class="medicine-details" style="display: none;">
                <div class="detail-grid">
                    <div class="detail-item">
                        <h4>Day Frequency</h4>
                        <p>M-T-W-Th-F-Sa-Su</p>
                    </div>
                    <div class="detail-item">
                        <h4>Dose Frequency</h4>
                        <p>1-0-0-0</p>
                    </div>
                    <div class="detail-item">
                        <h4>Quantity</h4>
                        <p>1 tablet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <h4>Duration</h4>
                        <p>Long-term</p>
                    </div>
                </div>
                <p><strong>Instructions:</strong> To prevent stroke. Avoid green leafy vegetables; get INR checked regularly. Stop if excessive bleeding, black stools, or unusual bruising occurs.</p>
                <div class="quick-actions">
                    <button class="action-btn secondary-btn">
                        <i class="fas fa-notes-medical"></i>
                        View History
                    </button>
                    <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                        <i class="fas fa-info-circle"></i>
                        Explain Medicine
                    </button>
                </div>
            </div>
        </div>
        <div class="medicine-card" onclick="toggleDetails(this)">
            <div class="medicine-header">
                <div class="medicine-title">
                    <i class="fas fa-pills" style="color: var(--danger-color)"></i>
                    <h3>Spironolactone 25 mg</h3>
                </div>
                <span class="medicine-badge badge-active">Active</span>
            </div>
            <div class="medicine-details" style="display: none;">
                <div class="detail-grid">
                    <div class="detail-item">
                        <h4>Day Frequency</h4>
                        <p>M-T-W-Th-F-Sa-Su</p>
                    </div>
                    <div class="detail-item">
                        <h4>Dose Frequency</h4>
                        <p>1-0-0-0</p>
                    </div>
                    <div class="detail-item">
                        <h4>Quantity</h4>
                        <p>1 tablet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <h4>Duration</h4>
                        <p>Long-term</p>
                    </div>
                </div>
                <p><strong>Instructions:</strong> To prevent stroke. Avoid green leafy vegetables; get INR checked regularly. Stop if excessive bleeding, black stools, or unusual bruising occurs.</p>
                <div class="quick-actions">
                    <button class="action-btn secondary-btn">
                        <i class="fas fa-notes-medical"></i>
                        View History
                    </button>
                    <button class="action-btn secondary-btn explain-medicine-btn" onclick="event.stopPropagation()">
                        <i class="fas fa-info-circle"></i>
                        Explain Medicine
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>
        </div>

        <!-- Right Panel - AI Assistant -->
        <div class="panel">
            <div class="patient-info">
                <div class="patient-avatar">JD</div>
                <div class="patient-details">
                    <h3>John Doe</h3>
                    <p>Next Appointment: March 1, 2025</p>
                    <p style="color: var(--text-secondary)">Patient ID: #12345</p>
                </div>
            </div>
            
            <div class="doctor-instructions">
                <div class="panel-header">
                    <h3>Doctor's Instructions</h3>
                    <div class="language-toggle">
                        <button class="action-btn secondary-btn language-btn active" data-lang="en">
                            <i class="fas fa-language"></i> English
                        </button>
                        <button class="action-btn secondary-btn language-btn" data-lang="hi">
                            <i class="fas fa-language"></i> हिंदी
                        </button>
                    </div>
                </div>
                
                <div class="instruction-content">
                    <div class="instruction-text" data-lang="en">
                        <p>Take Amoxicillin 500mg three times a day after meals. Complete the entire course of antibiotics even if you start feeling better. Avoid alcohol and dairy products 2 hours before and after taking the medication.</p>
                        <div class="instruction-actions">
                            <button class="action-btn primary-btn play-instructions-btn">
                                <i class="fas fa-play-circle"></i> Play Instructions
                            </button>
                        </div>
                    </div>
                    
                    <div class="instruction-text" data-lang="hi" style="display: none;">
                        <p>अमोक्सीसिलिन 500 मिलीग्राम को दिन में तीन बार भोजन के बाद लें। एंटीबायोटिक का पूरा कोर्स पूरा करें, भले ही आप बेहतर महसूस करने लगें। दवा लेने से 2 घंटे पहले और बाद में शराब और डेयरी उत्पादों से बचें।</p>
                        <div class="instruction-actions">
                            <button class="action-btn primary-btn play-instructions-btn">
                                <i class="fas fa-play-circle"></i> निर्देश सुनें
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ai-assistant">
                <div class="chat-header">
                    <div class="chat-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="chat-info">
                        <h3>OneDose AI Assistant</h3>
                        <p>Your personal health companion</p>
                    </div>
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message bot-message">
                            <div class="message-content">
                                <p>Hello! I'm your OneDose AI Assistant. How can I help you today?</p>
                            </div>
                        </div>
                        <div class="chat-message suggestion-message">
                            <div class="message-content">
                                <p>Quick suggestions:</p>
                                <div class="quick-suggestions">
                                    <button class="suggestion-chip" onclick="sendQuickQuestion('What medications are due now?')">
                                        <i class="fas fa-pills"></i> Medications Due
                                    </button>
                                    <button class="suggestion-chip" onclick="sendQuickQuestion('What about Janki\'s surgery?')">
                                        <i class="fas fa-calendar-alt"></i> Surgery Preparation
                                    </button>
                                    <button class="suggestion-chip" onclick="sendQuickQuestion('What if I miss a dose?')">
                                        <i class="fas fa-clock"></i> Missed Dose
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="chat-input-wrapper">
                        <button class="voice-input-btn" id="voiceInputBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <input 
                            type="text" 
                            id="chatInput" 
                            placeholder="Type your health question..." 
                            onkeypress="handleChatInput(event)"
                        >
                        <button class="send-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="voiceStatus" class="voice-status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Search Popup -->
    <div id="patientSearchPopup" class="patient-search-popup">
        <div class="patient-search-popup-content">
            <div class="patient-search-header">
                <input 
                    type="text" 
                    id="patientSearchPopupInput" 
                    placeholder="Search patients..." 
                >
                <button class="close-popup-btn" onclick="closePatientSearchPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="patientSearchResults" class="patient-search-popup-results">
                <!-- Patient results will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="chat.js"></script>
    <script src="patient-search.js"></script>
    <script>
        // Enhanced Text-to-Speech Implementation
function speakMessage(message, lang = 'en-US') {
    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        console.error('Text-to-speech not supported in this browser');
        alert('Text-to-speech is not supported in your browser');
        return;
    }

    // Cancel any ongoing speech
    window.speechSynthesis.cancel();

    // Create utterance
    const utterance = new SpeechSynthesisUtterance(message);
    
    // Configure speech settings
    utterance.lang = lang;
    utterance.rate = 1.0;  // Normal speed
    utterance.pitch = 1.0; // Normal pitch
    utterance.volume = 1.0; // Maximum volume

    // Select appropriate voice
    const voices = window.speechSynthesis.getVoices();
    const preferredVoice = voices.find(voice => 
        voice.lang.startsWith(lang) && !voice.localService
    ) || voices.find(voice => 
        voice.lang.startsWith(lang)
    ) || voices[0];

    if (preferredVoice) {
        utterance.voice = preferredVoice;
    }

    // Add event handlers
    utterance.onstart = () => {
        console.log('Started speaking');
        // Visual feedback that speech has started
        const speakBtn = document.querySelector('.speak-btn');
        if (speakBtn) {
            speakBtn.innerHTML = '<i class="fas fa-volume-high"></i>';
            speakBtn.style.color = '#4caf50';
        }
    };

    utterance.onend = () => {
        console.log('Finished speaking');
        // Reset button state
        const speakBtn = document.querySelector('.speak-btn');
        if (speakBtn) {
            speakBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            speakBtn.style.color = '';
        }
    };

    utterance.onerror = (event) => {
        console.error('Speech synthesis error:', event);
        alert('There was an error playing the speech. Please try again.');
        // Reset button state
        const speakBtn = document.querySelector('.speak-btn');
        if (speakBtn) {
            speakBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            speakBtn.style.color = '';
        }
    };

    // Initialize voices if they haven't been loaded yet
    if (window.speechSynthesis.getVoices().length === 0) {
        window.speechSynthesis.addEventListener('voiceschanged', () => {
            // Try speaking again once voices are loaded
            window.speechSynthesis.speak(utterance);
        }, { once: true });
    } else {
        // Speak immediately if voices are already loaded
        window.speechSynthesis.speak(utterance);
    }
}

// Initialize voices as soon as possible
document.addEventListener('DOMContentLoaded', () => {
    // Force loading of voices
    window.speechSynthesis.getVoices();
});
        
        // Initial toggleDetails function for expanding/collapsing cards
        // Speech Recognition Setup
const setupSpeechRecognition = () => {
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const chatInput = document.getElementById('chatInput');
    const voiceStatus = document.getElementById('voiceStatus');

    // Fallback for different browser implementations
    const SpeechRecognition = 
        window.SpeechRecognition || 
        window.webkitSpeechRecognition || 
        window.mozSpeechRecognition || 
        window.msSpeechRecognition;

    if (!SpeechRecognition) {
        voiceInputBtn.style.display = 'none';
        voiceStatus.textContent = 'Speech recognition not supported in this browser';
        voiceStatus.style.color = '#dc2626';
        return;
    }

    const recognition = new SpeechRecognition();
    
    // Configuration
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    // Event Handlers
    recognition.onstart = () => {
        voiceInputBtn.classList.add('active');
        voiceStatus.textContent = 'Listening... Speak now';
        voiceStatus.style.color = 'var(--primary-color)';
        voiceInputBtn.querySelector('i').classList.remove('fa-microphone');
        voiceInputBtn.querySelector('i').classList.add('fa-microphone-lines');
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        
        if (transcript) {
            chatInput.value = transcript;
            voiceStatus.textContent = 'Processing your request...';
            voiceStatus.style.color = 'var(--success-color)';
            
            // Automatically send message after a short delay
            setTimeout(() => {
                sendMessage();
            }, 500);
        }
    };

    recognition.onend = () => {
        voiceInputBtn.classList.remove('active');
        voiceInputBtn.querySelector('i').classList.remove('fa-microphone-lines');
        voiceInputBtn.querySelector('i').classList.add('fa-microphone');
        voiceStatus.textContent = '';
    };

    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        voiceInputBtn.classList.remove('active');

        // Provide user-friendly error messages
        switch(event.error) {
            case 'no-speech':
                voiceStatus.textContent = 'No speech detected. Please try again.';
                break;
            case 'audio-capture':
                voiceStatus.textContent = 'No microphone found. Check your device settings.';
                break;
            case 'not-allowed':
                voiceStatus.textContent = 'Microphone access denied. Please check browser permissions.';
                break;
            default:
                voiceStatus.textContent = 'Speech recognition failed. Please try again.';
        }
        voiceStatus.style.color = '#dc2626';
    };

    // Voice Input Button Click Handler
    voiceInputBtn.addEventListener('click', () => {
        try {
            recognition.abort(); // Stop any ongoing recognition
            recognition.start(); // Start new recognition
        } catch (error) {
            console.error('Speech recognition error:', error);
            voiceStatus.textContent = 'Speech recognition not available';
            voiceStatus.style.color = '#dc2626';
        }
    });

    // Add language selector
    const languageSelect = document.createElement('select');
    languageSelect.innerHTML = `
        <option value="en-US">English</option>
        <option value="hi-IN">Hindi</option>
        <option value="es-ES">Spanish</option>
        <option value="fr-FR">French</option>
    `;
    languageSelect.addEventListener('change', (e) => {
        recognition.lang = e.target.value;
    });
    languageSelect.style.marginLeft = '12px';
    languageSelect.style.padding = '4px';
    languageSelect.style.borderRadius = '4px';

    // Append language select near voice input
    voiceInputBtn.parentNode.insertBefore(languageSelect, voiceInputBtn.nextSibling);
};

// Initialize speech recognition when the DOM is loaded
document.addEventListener('DOMContentLoaded', setupSpeechRecognition);
        function toggleDetails(card) {
            const details = card.querySelector('.medicine-details');
            const allDetails = document.querySelectorAll('.medicine-details');
            
            // Close all other details
            allDetails.forEach(detail => {
                if (detail !== details) {
                    detail.style.display = 'none';
                }
            });

            // Toggle clicked details
            if (details.style.display === 'block') {
                details.style.display = 'none';
            } else {
                details.style.display = 'block';
            }
        }

        // Function to handle search functionality
        function searchMedications(query) {
            query = query.toLowerCase();
            const cards = document.querySelectorAll('.medicine-card');
            
            cards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const details = card.querySelector('.medicine-details').textContent.toLowerCase();
                
                if (title.includes(query) || details.includes(query)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Chatbot Functionality
        function createMessageElement(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', `${type}-message`);
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            contentDiv.innerHTML = `<p>${message}</p>`;
            
            messageDiv.appendChild(contentDiv);
            return messageDiv;
        }

        function appendMessage(message, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = createMessageElement(message, type);
            
            // Add speak button for bot messages
            if (type === 'bot') {
                const speakButton = document.createElement('button');
                speakButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                speakButton.classList.add('speak-btn');
                speakButton.onclick = () => {
                    // Determine language based on current language toggle
                    const activeLangBtn = document.querySelector('.language-btn.active');
                    const lang = activeLangBtn ? activeLangBtn.dataset.lang : 'en';
                    speakMessage(message, lang === 'hi' ? 'hi-IN' : 'en-US');
                };
                messageElement.querySelector('.message-content').appendChild(speakButton);
            }
            
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendQuickQuestion(question) {
    // Add user message
    appendMessage(question, 'user');

    // Bilingual static responses
    const staticResponses = {
        'What medications are due now?': {
            en: `It's 2 PM, so it's time for Janki Devi's afternoon medications.
She needs to take:
Furosemide 40 mg (1 tablet) for fluid retention. Remember to monitor her urine output and watch for side effects like severe dehydration, dizziness, or weakness.
Clopidogrel 75 mg (1 tablet) to prevent clots. Remind her to stop taking this medication 5 days before any planned surgery or dental procedure.
Let me know if you need any more information about Janki Devi or her medications!`,
            hi: `अभी दोपहर 2 बजे हैं, इसलिए जानकी देवी की दोपहर की दवाएं लेने का समय हो गया है।
उन्हें लेना है:
फ्यूरोसेमाइड 40 मिलीग्राम (1 टैबलेट) तरल प्रतिधारण के लिए। उनके मूत्र उत्पादन की निगरानी करना और गंभीर निर्जलीकरण, चक्कर आना, या कमजोरी जैसे दुष्प्रभावों पर ध्यान देना याद रखें।
क्लोपिडोग्रेल 75 मिलीग्राम (1 टैबलेट) रक्त के थक्कों को रोकने के लिए। उन्हें याद दिलाएं कि किसी भी नियोजित सर्जरी या दंत चिकित्सा प्रक्रिया से 5 दिन पहले इस दवा को लेना बंद कर दें।
अगर आपको जानकी देवी या उनकी दवाओं के बारे में कोई और जानकारी चाहिए तो मुझे बताएं!`
        },
        'What about Janki\'s surgery?': {
            en: `I understand Janki Devi has a surgery planned for the day after tomorrow.

Important Reminder:
Janki needs to stop taking Clopidogrel 75 mg five days before any surgery or dental procedure. This is critical to minimize the risk of excessive bleeding during the procedure.

Recommended Action:
Immediately inform the doctor about the planned surgery.
Confirm with the doctor whether and when to stop Clopidogrel, as well as any other medications, considering her complex medical history.
Time is crucial in this situation to ensure Janki's safety.`,
            hi: `मैं समझता हूं कि जानकी देवी की सर्जरी परसों के लिए नियोजित है।

महत्वपूर्ण अनुस्मारक:
जानकी को किसी भी सर्जरी या दंत चिकित्सा प्रक्रिया से पांच दिन पहले क्लोपिडोग्रेल 75 मिलीग्राम लेना बंद करना होगा। प्रक्रिया के दौरान अत्यधिक रक्तस्राव के जोखिम को कम करने के लिए यह महत्वपूर्ण है।

अनुशंसित कार्रवाई:
नियोजित सर्जरी के बारे में तुरंत डॉक्टर को सूचित करें।
डॉक्टर से पुष्टि करें कि क्लोपिडोग्रेल और अन्य दवाओं को कब बंद करना है, उनके जटिल चिकित्सा इतिहास को ध्यान में रखते हुए।
जानकी की सुरक्षा सुनिश्चित करने के लिए समय महत्वपूर्ण है।`
        }
    };

    // Create and append bot response with both languages
    if (staticResponses[question]) {
        const response = staticResponses[question];
        
        // Create message container
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', 'bot-message');
        
        // Create content container
        const contentDiv = document.createElement('div');
        contentDiv.classList.add('message-content');
        
        // Add English response
        const enText = document.createElement('p');
        enText.textContent = response.en;
        contentDiv.appendChild(enText);
        
        // Add Hindi response
        const hiText = document.createElement('p');
        hiText.textContent = response.hi;
        hiText.style.marginTop = '10px';
        contentDiv.appendChild(hiText);
        
        // Add language-specific speak buttons
        const buttonContainer = document.createElement('div');
        buttonContainer.style.marginTop = '10px';
        buttonContainer.style.display = 'flex';
        buttonContainer.style.gap = '10px';
        
        // English speak button
        const speakEnBtn = document.createElement('button');
        speakEnBtn.innerHTML = '<i class="fas fa-volume-up"></i> English';
        speakEnBtn.classList.add('speak-btn');
        speakEnBtn.onclick = () => speakMessage(response.en, 'en-US');
        buttonContainer.appendChild(speakEnBtn);
        
        // Hindi speak button
        const speakHiBtn = document.createElement('button');
        speakHiBtn.innerHTML = '<i class="fas fa-volume-up"></i> हिंदी';
        speakHiBtn.classList.add('speak-btn');
        speakHiBtn.onclick = () => speakMessage(response.hi, 'hi-IN');
        buttonContainer.appendChild(speakHiBtn);
        
        contentDiv.appendChild(buttonContainer);
        messageDiv.appendChild(contentDiv);
        
        // Add to chat
        document.getElementById('chatMessages').appendChild(messageDiv);
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    } else {
        // Handle non-static questions as before
        fetchGeminiResponse(question)
            .then(response => appendMessage(response, 'bot'))
            .catch(() => appendMessage('Sorry, I couldn\'t process that request.', 'bot'));
    }
}
        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            if (message) {
                // Add user message
                appendMessage(message, 'user');
                
                // Clear input
                chatInput.value = '';

                try {
                    // Use fetchGeminiResponse from chat.js
                    const response = await fetchGeminiResponse(message);
                    
                    // Add bot response
                    appendMessage(response, 'bot');
                } catch (error) {
                    appendMessage('Sorry, I couldn\'t process that request.', 'bot');
                }
            }
        }

        // Optional: Add a welcome message after page load
        document.addEventListener('DOMContentLoaded', () => {
            const welcomeMessages = [
                "Hello! I'm your OneDose AI Health Assistant.",
                "Need help understanding your medications?",
                "I'm here to answer your health-related questions."
            ];

            // Randomly select a welcome message
            const randomWelcome = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
            
            // Simulate typing effect for welcome message
            setTimeout(() => {
                appendMessage(randomWelcome, 'bot');
            }, 300);
        });

        // Language Toggle Functionality
        document.addEventListener('DOMContentLoaded', () => {
            const languageButtons = document.querySelectorAll('.language-btn');
            const instructionTexts = document.querySelectorAll('.instruction-text');
            const playButtons = document.querySelectorAll('.play-instructions-btn');

            languageButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const lang = button.dataset.lang;

                    // Toggle active state on buttons
                    languageButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    // Show/hide instruction texts
                    instructionTexts.forEach(text => {
                        text.style.display = text.dataset.lang === lang ? 'block' : 'none';
                    });
                });
            });

        // Play Instructions (Text-to-Speech)
        playButtons.forEach(button => {
            button.addEventListener('click', () => {
                const activeInstructionText = button.closest('.instruction-text').textContent.trim();
                
                // Use Web Speech API for text-to-speech
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(activeInstructionText);
                    
                    // Set language based on active language
                    const lang = button.closest('.instruction-text').dataset.lang;
                    utterance.lang = lang === 'hi' ? 'hi-IN' : 'en-US';
                    
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Text-to-speech not supported in this browser.');
                }
            });
        });

        // Add a global text-to-speech function for chat messages
        // Enhanced Text-to-Speech Implementation
function speakMessage(message, lang = 'en-US') {
    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        console.error('Text-to-speech not supported in this browser');
        alert('Text-to-speech is not supported in your browser');
        return;
    }

    // Cancel any ongoing speech
    window.speechSynthesis.cancel();

    // Create utterance
    const utterance = new SpeechSynthesisUtterance(message);
    
    // Configure speech settings
    utterance.lang = lang;
    utterance.rate = 1.0;  // Normal speed
    utterance.pitch = 1.0; // Normal pitch
    utterance.volume = 1.0; // Maximum volume

    // Select appropriate voice
    const voices = window.speechSynthesis.getVoices();
    const preferredVoice = voices.find(voice => 
        voice.lang.startsWith(lang) && !voice.localService
    ) || voices.find(voice => 
        voice.lang.startsWith(lang)
    ) || voices[0];

    if (preferredVoice) {
        utterance.voice = preferredVoice;
    }

    // Add event handlers
    utterance.onstart = () => {
        console.log('Started speaking');
        // Visual feedback that speech has started
        const speakBtn = document.querySelector('.speak-btn');
        if (speakBtn) {
            speakBtn.innerHTML = '<i class="fas fa-volume-high"></i>';
            speakBtn.style.color = '#4caf50';
        }
    };

    utterance.onend = () => {
        console.log('Finished speaking');
        // Reset button state
        const speakBtn = document.querySelector('.speak-btn');
        if (speakBtn) {
            speakBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            speakBtn.style.color = '';
        }
    };

    utterance.onerror = (event) => {
        console.error('Speech synthesis error:', event);
        alert('There was an error playing the speech. Please try again.');
        // Reset button state
        const speakBtn = document.querySelector('.speak-btn');
        if (speakBtn) {
            speakBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            speakBtn.style.color = '';
        }
    };

    // Initialize voices if they haven't been loaded yet
    if (window.speechSynthesis.getVoices().length === 0) {
        window.speechSynthesis.addEventListener('voiceschanged', () => {
            // Try speaking again once voices are loaded
            window.speechSynthesis.speak(utterance);
        }, { once: true });
    } else {
        // Speak immediately if voices are already loaded
        window.speechSynthesis.speak(utterance);
    }
}

        // Add CSS for speak button
        const speakButtonStyle = document.createElement('style');
        speakButtonStyle.textContent = `
.speak-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    margin-left: 10px;
    cursor: pointer;
    transition: color 0.3s ease;
}
.speak-btn:hover {
    color: var(--primary-hover);
}
`;
        document.head.appendChild(speakButtonStyle);
    });
    </script>
</body>
</html>